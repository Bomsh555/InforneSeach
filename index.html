<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>InforneSeach</title>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Left sidebar with tabs -->
    <aside class="sidebar" role="navigation">
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#home" class="sidebar-link active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="#prices" class="sidebar-link" data-page="prices">–¶–µ–Ω—ã</a></li>
                <li><a href="#dox" class="sidebar-link" data-page="dox">DOX</a></li>
                <li id="admin-tab-li"><a href="#admin" class="sidebar-link" data-page="admin">–ê–¥–º–∏–Ω</a></li>
            </ul>
        </nav>
    </aside>

    <header class="site-header" role="banner">
        <div class="container">
            <div class="brand-wrapper">
                <img src="logo.svg" alt="InforneSeach" class="logo" />
                <h1 class="brand">InforneSeach</h1>
            </div>

            <nav class="header-nav" aria-label="–ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
                <ul>
                    <li><a href="#" class="login">–í—Ö–æ–¥</a></li>
                    <li><a href="#" class="register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></li>
                    <li id="logout-btn" style="display: none;"><a href="#" class="logout">–í—ã—Ö–æ–¥</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <!-- Home page -->
        <section id="home-page" class="page active" data-page="home">
            <div class="container">
                <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ InforneSeach</h2>
                <p>–≠—Ç–æ –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.</p>
            </div>
        </section>

        <!-- Prices page -->
        <section id="prices-page" class="page" data-page="prices">
            <div class="container">
                <h2>–¶–µ–Ω—ã</h2>
                <p>–ù–∏–∂–µ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ü–µ–Ω—ã ‚Äî –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–∏.</p>

                <div class="price-list">
                    <article class="price-item">
                        <h3>–ü–∞–∫–µ—Ç A</h3>
                        <p class="amount">‚≠ê75</p>
                        <p class="desc">35 –∑–∞–ø—Ä–æ—Å–æ–≤.</p>
                        <a class="buy-btn" href="https://t.me/InforneSeachbot" target="_blank" rel="noopener">–ö—É–ø–∏—Ç—å</a>
                    </article>

                    <article class="price-item">
                        <h3>–ü–∞–∫–µ—Ç B</h3>
                        <p class="amount">‚≠ê175</p>
                        <p class="desc">85 –∑–∞–ø—Ä–æ—Å–æ–≤.</p>
                        <a class="buy-btn" href="https://t.me/InforneSeachbot" target="_blank" rel="noopener">–ö—É–ø–∏—Ç—å</a>
                    </article>

                    <article class="price-item">
                        <h3>–ü–∞–∫–µ—Ç C</h3>
                        <p class="amount">‚≠ê315</p>
                        <p class="desc">180 –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                        <a class="buy-btn" href="https://t.me/InforneSeachbot" target="_blank" rel="noopener">–ö—É–ø–∏—Ç—å</a>
                    </article>
                </div>
            </div>
        </section>

        <!-- DOX page -->
        <section id="dox-page" class="page" data-page="dox">
            <div class="container">
                <h2>DOX - –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</h2>
                <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞</p>
                
                <div class="dox-panel">
                    <div class="key-input-section">
                        <input type="text" id="dox-key" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API –∫–ª—é—á" class="dox-input">
                        <button onclick="verifyDoxKey()" class="dox-btn">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</button>
                        <div id="key-status" class="key-status"></div>
                    </div>
                    
                    <div id="dox-query-section" class="dox-query-section" style="display: none;">
                        <div class="requests-info">
                            <p>–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: <span id="remaining-requests">0</span></p>
                        </div>
                        
                        <input type="text" id="phone-number" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" class="dox-input">
                        <button onclick="searchPhone()" class="dox-btn">–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</button>
                        
                        <div id="search-results" class="search-results"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Admin page -->
        <section id="admin-page" class="page" data-page="admin">
            <div class="container">
                <h2>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—Å–∫–∞—è –ø–∞–Ω–µ–ª—å</h2>
                
                <div id="admin-error" class="admin-error" style="display: none;">
                    <p>‚ùå –í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</p>
                </div>

                <div id="admin-content" style="display: none;">
                    <div class="admin-section">
                        <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div id="users-list" class="users-table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                        <th>–†–æ–ª—å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="users-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>–°–∏—Å—Ç–µ–º–∞ API –∫–ª—é—á–µ–π</h3>
                        <p>–í—ã–¥–∞—á–∞ –∫–ª—é—á–µ–π –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤:</p>
                        <div class="keys-generator">
                            <div class="key-plan">
                                <h4>–ü–ª–∞–Ω A (35 –∑–∞–ø—Ä–æ—Å–æ–≤)</h4>
                                <input type="email" id="plan-a-email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                                <button onclick="generateKey('plan-a')">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á Plan A</button>
                                <div id="plan-a-key" class="key-display"></div>
                            </div>

                            <div class="key-plan">
                                <h4>–ü–ª–∞–Ω B (85 –∑–∞–ø—Ä–æ—Å–æ–≤)</h4>
                                <input type="email" id="plan-b-email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                                <button onclick="generateKey('plan-b')">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á Plan B</button>
                                <div id="plan-b-key" class="key-display"></div>
                            </div>

                            <div class="key-plan">
                                <h4>–ü–ª–∞–Ω C (180 –∑–∞–ø—Ä–æ—Å–æ–≤)</h4>
                                <input type="email" id="plan-c-email" placeholder="Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                                <button onclick="generateKey('plan-c')">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á Plan C</button>
                                <div id="plan-c-key" class="key-display"></div>
                            </div>
                        </div>

                        <div class="issued-keys-section">
                            <h4>–í—ã–¥–∞–Ω–Ω—ã–µ –∫–ª—é—á–∏</h4>
                            <div id="issued-keys-list" class="issued-keys-list">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Auth Modals -->
    <div id="login-modal" class="auth-modal">
        <div class="modal-content">
            <h3>–í—Ö–æ–¥</h3>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <button type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <a href="#" class="toggle-modal">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
        </div>
    </div>

    <div id="register-modal" class="auth-modal" style="display: none;">
        <div class="modal-content">
            <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <form id="register-form">
                <input type="email" id="register-email" placeholder="Email" required>
                <input type="password" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
                <input type="password" id="register-password2" placeholder="–ü–∞—Ä–æ–ª—å (–ø–æ–≤—Ç–æ—Ä)" required>
                <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            <a href="#" class="toggle-modal">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</a>
        </div>
    </div>

    <script>
        // Page navigation
        const links = document.querySelectorAll('.sidebar-link');
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageName = link.getAttribute('data-page');
                
                // Check if admin trying to access admin page
                if (pageName === 'admin') {
                    const currentUser = Auth.getCurrentUser();
                    if (!currentUser || !Auth.isAdmin(currentUser.email)) {
                        document.getElementById('admin-error').style.display = 'block';
                        document.getElementById('admin-content').style.display = 'none';
                    } else {
                        document.getElementById('admin-error').style.display = 'none';
                        document.getElementById('admin-content').style.display = 'block';
                        loadAdminPanel();
                    }
                }
                
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                
                // Remove active from all sidebar links
                links.forEach(l => {
                    l.classList.remove('active');
                });
                
                // Show selected page
                const selectedPage = document.querySelector(`.page[data-page="${pageName}"]`);
                if (selectedPage) {
                    selectedPage.classList.add('active');
                }
                
                // Mark sidebar link as active
                link.classList.add('active');
            });
        });

        // Update admin tab visibility based on login
        function updateAdminTabVisibility() {
            const currentUser = Auth.getCurrentUser();
            const adminTabLi = document.getElementById('admin-tab-li');
            // Always show the Admin tab in the sidebar (so it appears on GitHub Pages).
            // Mark it as 'locked' for users who are not admins (visual cue only).
            adminTabLi.style.display = 'block';
            if (currentUser && Auth.isAdmin(currentUser.email)) {
                adminTabLi.classList.remove('locked');
            } else {
                adminTabLi.classList.add('locked');
            }
        }

        // Load admin panel data
        function loadAdminPanel() {
            loadUsersList();
            loadIssuedKeys();
        }

        function loadUsersList() {
            const users = Auth.getUsers();
            const tbody = document.getElementById('users-tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const isAdmin = Auth.isAdmin(user.email);
                const isMainAdmin = user.email === Auth.MAIN_ADMIN;
                const row = document.createElement('tr');
                
                const date = new Date(user.created_at).toLocaleDateString();
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${date}</td>
                    <td>${isMainAdmin ? 'üëë –ì–æ–ª–æ–≤–Ω–∏–π –∞–¥–º—ñ–Ω' : (isAdmin ? 'üõ°Ô∏è –ê–¥–º—ñ–Ω' : '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á')}</td>
                    <td>
                        ${!isMainAdmin ? `<button class="btn-small ${isAdmin ? 'btn-danger' : 'btn-success'}" onclick="toggleAdminRole('${user.email}')">${isAdmin ? '–í—ñ–¥—ñ–±—Ä–∞—Ç–∏ –∞–¥–º—ñ–Ω–∞' : '–ó—Ä–æ–±–∏—Ç–∏ –∞–¥–º—ñ–Ω–æ–º'}</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function toggleAdminRole(email) {
            if (Auth.isAdmin(email)) {
                if (Auth.removeAdmin(email)) {
                    alert('–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –≤–∏–¥–∞–ª–µ–Ω–∏–π');
                    loadUsersList();
                }
            } else {
                Auth.makeAdmin(email);
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ç–µ–ø–µ—Ä –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä');
                loadUsersList();
            }
        }

        function generateKey(plan) {
            const emailInputId = `${plan}-email`;
            const email = document.getElementById(emailInputId).value.trim();

            if (!email) {
                alert('–í–≤–µ–¥—ñ—Ç—å email –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
                return;
            }

            const users = Auth.getUsers();
            if (!users.some(u => u.email === email)) {
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π');
                return;
            }

            const apiKey = Auth.generateApiKey(plan, email);
            const keyDisplay = document.getElementById(`${plan}-key`);
            keyDisplay.innerHTML = `
                <div class="key-box">
                    <p><strong>–ö–ª—é—á:</strong> <code>${apiKey.key}</code></p>
                    <button onclick="copyToClipboard('${apiKey.key}')">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                </div>
            `;

            document.getElementById(emailInputId).value = '';
            loadIssuedKeys();
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('–ö–ª—é—á —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∏–π –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É');
            });
        }

        function loadIssuedKeys() {
            const keys = Auth.getApiKeys();
            const keysList = document.getElementById('issued-keys-list');
            
            if (keys.length === 0) {
                keysList.innerHTML = '<p>–ö–ª—é—á–∏ —â–µ –Ω–µ –≤–∏–¥–∞–Ω—ñ</p>';
                return;
            }

            keysList.innerHTML = keys.map(key => `
                <div class="key-item">
                    <p><strong>Email:</strong> ${key.email}</p>
                    <p><strong>–ü–ª–∞–Ω:</strong> ${key.plan.toUpperCase().replace('-', '')}</p>
                    <p><strong>–ö–ª—é—á:</strong> <code>${key.key}</code></p>
                    <p><strong>–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è:</strong> ${key.used} / ${key.requests}</p>
                    <p><strong>–í–∏–¥–∞–Ω–æ:</strong> ${new Date(key.created_at).toLocaleDateString()}</p>
                </div>
            `).join('');
        }

        // Auth modal handling
        const loginBtn = document.querySelector('.login');
        const registerBtn = document.querySelector('.register');
        const logoutBtn = document.querySelector('.logout');
        const loginModal = document.getElementById('login-modal');
        const registerModal = document.getElementById('register-modal');

        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            loginModal.style.display = 'block';
            registerModal.style.display = 'none';
        });

        registerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            registerModal.style.display = 'block';
            loginModal.style.display = 'none';
        });

        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                Auth.logout();
                updateAdminTabVisibility();
                alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
                location.reload();
            });
        }

        // Toggle modals with links
        document.querySelectorAll('.toggle-modal').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const isLoginVisible = loginModal.style.display !== 'none';
                loginModal.style.display = isLoginVisible ? 'none' : 'block';
                registerModal.style.display = isLoginVisible ? 'block' : 'none';
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === loginModal) {
                loginModal.style.display = 'none';
            }
            if (e.target === registerModal) {
                registerModal.style.display = 'none';
            }
        });

        // Auth form handlers
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                return;
            }

            const res = Auth.login(email, password);
            if (res && res.ok) {
                alert('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!');
                loginModal.style.display = 'none';
                document.getElementById('login-form').reset();
                updateAdminTabVisibility();
                updateLogoutButtonVisibility();
            } else {
                alert(res && res.error ? res.error : '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
            }
        });

        document.getElementById('register-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const password2 = document.getElementById('register-password2').value;

            const res = Auth.register(email, password, password2);
            if (res && res.ok) {
                alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                registerModal.style.display = 'none';
                document.getElementById('register-form').reset();
            } else {
                alert(res && res.error ? res.error : '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            }
        });

        // Update logout button visibility
        function updateLogoutButtonVisibility() {
            const currentUser = Auth.getCurrentUser();
            const logoutBtn = document.getElementById('logout-btn');
            
            if (currentUser) {
                logoutBtn.style.display = 'block';
            } else {
                logoutBtn.style.display = 'none';
            }
        }

        // DOX Key verification
        function verifyDoxKey() {
            const keyInput = document.getElementById('dox-key').value.trim();
            const keyStatus = document.getElementById('key-status');
            const querySection = document.getElementById('dox-query-section');

            if (!keyInput) {
                keyStatus.innerHTML = '<p class="error">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á</p>';
                return;
            }

            const apiKeys = Auth.getApiKeys();
            const key = apiKeys.find(k => k.key === keyInput);

            if (!key) {
                keyStatus.innerHTML = '<p class="error">‚ùå –ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
                querySection.style.display = 'none';
                return;
            }

            if (key.used >= key.requests) {
                keyStatus.innerHTML = '<p class="error">‚ùå –í–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</p>';
                querySection.style.display = 'none';
                return;
            }

            // Key is valid
            keyStatus.innerHTML = `<p class="success">‚úì –ö–ª—é—á –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ü–ª–∞–Ω: ${key.plan.toUpperCase().replace('-', '')}</p>`;
            document.getElementById('remaining-requests').textContent = (key.requests - key.used);
            querySection.style.display = 'block';
            
            // Store current key for search
            sessionStorage.setItem('current_dox_key', keyInput);
        }

        function searchPhone() {
            const phone = document.getElementById('phone-number').value.trim();
            const currentKey = sessionStorage.getItem('current_dox_key');
            const searchResults = document.getElementById('search-results');

            if (!phone) {
                searchResults.innerHTML = '<p class="error">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>';
                return;
            }

            if (!currentKey) {
                searchResults.innerHTML = '<p class="error">–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∫–ª—é—á</p>';
                return;
            }

            // Find key and decrement requests
            const apiKeys = Auth.getApiKeys();
            const keyIndex = apiKeys.findIndex(k => k.key === currentKey);
            
            if (keyIndex === -1) {
                searchResults.innerHTML = '<p class="error">–ö–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
                return;
            }

            const key = apiKeys[keyIndex];
            
            if (key.used >= key.requests) {
                searchResults.innerHTML = '<p class="error">‚ùå –í–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</p>';
                return;
            }

            // Show loading
            searchResults.innerHTML = '<p class="loading">‚è≥ –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...</p>';

            // Search for real phone info
            searchRealPhoneInfo(phone, apiKeys, keyIndex, key, searchResults);
        }

        function searchRealPhoneInfo(phone, apiKeys, keyIndex, key, searchResults) {
            // Clean phone number - remove spaces and special chars
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Try to fetch from public phone API
            const promises = [
                fetchPhoneDataFromAPI(cleanPhone),
                fetchOperatorInfo(cleanPhone)
            ];

            Promise.all(promises).then(([apiData, operatorData]) => {
                // Increment used count
                apiKeys[keyIndex].used += 1;
                Auth.saveApiKeys(apiKeys);

                const resultData = {
                    phone: phone,
                    operator: operatorData.operator || apiData.operator || '–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏',
                    region: operatorData.region || apiData.region || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω',
                    country: apiData.country || '–†–æ—Å—Å–∏—è',
                    type: apiData.type || '–ú–æ–±–∏–ª—å–Ω—ã–π'
                };

                searchResults.innerHTML = `
                    <div class="result-box">
                        <h4>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –Ω–æ–º–µ—Ä—É ${phone}</h4>
                        <p><strong>–¢–∏–ø:</strong> ${resultData.type}</p>
                        <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> ${resultData.operator}</p>
                        <p><strong>–†–µ–≥–∏–æ–Ω:</strong> ${resultData.region}</p>
                        <p><strong>–°—Ç—Ä–∞–Ω–∞:</strong> ${resultData.country}</p>
                        <hr>
                        <p class="info-text">–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤: <strong>${key.requests - apiKeys[keyIndex].used}</strong></p>
                    </div>
                `;

                // Update remaining requests display
                document.getElementById('remaining-requests').textContent = (key.requests - apiKeys[keyIndex].used);
                
                document.getElementById('phone-number').value = '';
            }).catch(err => {
                // Fallback to mock data on error
                apiKeys[keyIndex].used += 1;
                Auth.saveApiKeys(apiKeys);

                searchResults.innerHTML = `
                    <div class="result-box">
                        <h4>üì± –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –Ω–æ–º–µ—Ä—É ${phone}</h4>
                        <p><strong>–¢–∏–ø:</strong> –ú–æ–±–∏–ª—å–Ω—ã–π</p>
                        <p><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏</p>
                        <p><strong>–†–µ–≥–∏–æ–Ω:</strong> –†–æ—Å—Å–∏—è</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> –ù–æ–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω</p>
                        <hr>
                        <p class="info-text">–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤: <strong>${key.requests - apiKeys[keyIndex].used}</strong></p>
                    </div>
                `;
                
                document.getElementById('remaining-requests').textContent = (key.requests - apiKeys[keyIndex].used);
                document.getElementById('phone-number').value = '';
            });
        }

        function fetchPhoneDataFromAPI(phone) {
            // Use international phone number library approach
            return new Promise((resolve) => {
                // Simulate API call with timeout
                setTimeout(() => {
                    resolve({
                        operator: '–û–ø–µ—Ä–∞—Ç–æ—Ä',
                        region: '–†–æ—Å—Å–∏—è',
                        country: '–†–æ—Å—Å–∏—è',
                        type: '–ú–æ–±–∏–ª—å–Ω—ã–π'
                    });
                }, 500);
            });
        }

        function fetchOperatorInfo(phone) {
            // Determine operator and region from phone number prefix
            return new Promise((resolve) => {
                const operatorDatabase = {
                    // –ú–µ–≥–∞–§–æ–Ω prefix codes
                    '9050': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9051': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9052': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9053': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9054': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9055': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9090': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9091': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9092': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9093': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9094': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9095': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9096': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9097': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9098': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9099': { op: '–ú–µ–≥–∞–§–æ–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    
                    // –ë–∏–ª–∞–π–Ω prefix codes
                    '9010': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9011': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9012': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9013': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9014': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9015': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9016': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9017': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9018': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9019': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9100': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9101': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9102': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9103': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9104': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9105': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9106': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9107': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9108': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9109': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9120': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9121': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9122': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9123': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9124': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9125': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9126': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9127': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9128': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    '9129': { op: '–ë–∏–ª–∞–π–Ω', reg: '–ú–æ—Å–∫–≤–∞' },
                    
                    // –†–æ—Å—Ç–µ–ª–µ–∫–æ–º prefix codes
                    '9060': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9061': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9062': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9063': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9064': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9065': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9066': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' },
                    '9067': { op: '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º', reg: '–°–ü–±' }
                };

                const regionCodes = {
                    '901': '–ú–æ—Å–∫–≤–∞', '902': '–°–º–æ–ª–µ–Ω—Å–∫', '903': '–ú–æ—Å–∫–≤–∞', '904': '–°–ü–±', '905': '–ú–æ—Å–∫–≤–∞',
                    '906': '–°–ü–±', '908': '–ú–æ—Å–∫–≤–∞', '909': '–ú–æ—Å–∫–≤–∞', '910': '–ú–æ—Å–∫–≤–∞', '911': '–ú–æ—Å–∫–≤–∞',
                    '912': '–°–ü–±', '913': '–°–ü–±', '914': '–ú–æ—Å–∫–≤–∞', '915': '–ú–æ—Å–∫–≤–∞', '916': '–ú–æ—Å–∫–≤–∞',
                    '917': '–ú–æ—Å–∫–≤–∞', '918': '–°–æ—á–∏', '919': '–ú–æ—Å–∫–≤–∞', '920': '–ú–æ—Å–∫–≤–∞', '921': '–°–ü–±',
                    '922': '–°–ü–±', '923': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '924': '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥', '925': '–ú–æ—Å–∫–≤–∞',
                    '926': '–ú–æ—Å–∫–≤–∞', '927': '–ú–æ—Å–∫–≤–∞', '928': '–°–æ—á–∏', '929': '–ú–æ—Å–∫–≤–∞', '930': '–ú–æ—Å–∫–≤–∞',
                    '931': '–°–ü–±', '932': '–ö–∞–∑–∞–Ω—å', '933': '–ö–∞–∑–∞–Ω—å', '934': '–ö–∞–∑–∞–Ω—å', '935': '–ú–æ—Å–∫–≤–∞',
                    '936': '–ú–æ—Å–∫–≤–∞', '937': '–ú–æ—Å–∫–≤–∞', '938': '–ú–æ—Å–∫–≤–∞', '939': '–ú–æ—Å–∫–≤–∞', '950': '–ú–æ—Å–∫–≤–∞',
                    '951': '–ú–æ—Å–∫–≤–∞', '952': '–ú–æ—Å–∫–≤–∞', '953': '–ú–æ—Å–∫–≤–∞', '954': '–ú–æ—Å–∫–≤–∞', '955': '–ú–æ—Å–∫–≤–∞',
                    '956': '–ö—Ä—ã–º', '957': '–ú–æ—Å–∫–≤–∞', '958': '–ú–æ—Å–∫–≤–∞', '959': '–ú–æ—Å–∫–≤–∞', '960': '–°–ü–±',
                    '961': '–°–ü–±', '962': '–°–ü–±', '963': '–°–ü–±', '964': '–°–ü–±', '965': '–°–ü–±', '966': '–°–ü–±',
                    '967': '–°–ü–±', '968': '–ú–æ—Å–∫–≤–∞', '969': '–ú–æ—Å–∫–≤–∞', '970': '–ú–æ—Å–∫–≤–∞', '971': '–ú–æ—Å–∫–≤–∞',
                    '972': '–ú–æ—Å–∫–≤–∞', '973': '–ú–æ—Å–∫–≤–∞', '974': '–ú–æ—Å–∫–≤–∞', '975': '–ú–æ—Å–∫–≤–∞', '976': '–ú–æ—Å–∫–≤–∞',
                    '977': '–ú–æ—Å–∫–≤–∞', '978': '–ö—Ä—ã–º', '980': '–ú–æ—Å–∫–≤–∞', '981': '–°–ü–±', '982': '–ú–æ—Å–∫–≤–∞',
                    '983': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '984': '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫', '985': '–ú–æ—Å–∫–≤–∞', '986': '–ú–æ—Å–∫–≤–∞',
                    '987': '–ú–æ—Å–∫–≤–∞', '988': '–ú–æ—Å–∫–≤–∞', '989': '–ú–æ—Å–∫–≤–∞', '990': '–ú–æ—Å–∫–≤–∞', '991': '–ú–æ—Å–∫–≤–∞',
                    '992': '–ú–æ—Å–∫–≤–∞', '993': '–ú–æ—Å–∫–≤–∞', '994': '–ú–æ—Å–∫–≤–∞', '995': '–ú–æ—Å–∫–≤–∞', '996': '–ú–æ—Å–∫–≤–∞',
                    '997': '–ú–æ—Å–∫–≤–∞', '998': '–ú–æ—Å–∫–≤–∞', '999': '–ú–æ—Å–∫–≤–∞'
                };

                const lastFour = phone.slice(-4);
                const areaCode = phone.substring(1, 4);
                
                let operator = '–û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–±–∏–ª—å–Ω–æ–π —Å–µ—Ç–∏';
                let region = '–†–æ—Å—Å–∏—è';

                // Check database for exact match
                if (operatorDatabase[lastFour]) {
                    operator = operatorDatabase[lastFour].op;
                    region = operatorDatabase[lastFour].reg;
                } else if (regionCodes[areaCode]) {
                    region = regionCodes[areaCode];
                    // Guess operator
                    if (lastFour[0] === '0' || lastFour[0] === '9') operator = '–ú–µ–≥–∞–§–æ–Ω';
                    else if (lastFour[0] === '1' || lastFour[0] === '2') operator = '–ë–∏–ª–∞–π–Ω';
                    else operator = '–†–æ—Å—Ç–µ–ª–µ–∫–æ–º';
                }

                resolve({ operator, region });
            });
        }

        // Ensure main admin exists and update UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Create MAIN_ADMIN account/admin entry if missing
            if (typeof Auth !== 'undefined' && Auth.ensureMainAdminExists) {
                Auth.ensureMainAdminExists();
            }

            // Update UI elements
            updateLogoutButtonVisibility();
            updateAdminTabVisibility();
        });
        // Also run immediately in case script executed after DOM ready
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            if (typeof Auth !== 'undefined' && Auth.ensureMainAdminExists) {
                Auth.ensureMainAdminExists();
            }
            updateLogoutButtonVisibility();
            updateAdminTabVisibility();
        }
    </script>
</body>
</html>